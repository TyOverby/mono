<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Command (async.Async.Command)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">async</a> &#x00BB; <a href="../index.html">Async</a> &#x00BB; Command</nav><header class="odoc-preamble"><h1>Module <code><span>Async.Command</span></code></h1></header><div class="odoc-content"><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <span class="keyword">module</span> <span class="keyword">type</span> <span class="keyword">of</span> <span class="keyword">struct</span> <span class="keyword">include</span> <a href="../../Async_command/index.html">Async_command</a> <span class="keyword">end</span></span></code></summary><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <span class="keyword">module</span> <span class="keyword">type</span> <span class="keyword">of</span> <span class="keyword">struct</span> <span class="keyword">include</span> <a href="../../../core/Core/Command/index.html">Core.Command</a> <span class="keyword">end</span></span></code></summary><div class="odoc-include"><div class="odoc-spec"><div class="spec module-type" id="module-type-Enumerable_sexpable" class="anchored"><a href="#module-type-Enumerable_sexpable" class="anchor"></a><code><span><span class="keyword">module</span> <span class="keyword">type</span> Enumerable_sexpable</span><span> = <a href="../../Async_command/module-type-Enumerable_sexpable/index.html">Async_command.Enumerable_sexpable</a></span></code></div></div><div class="odoc-spec"><div class="spec module-type" id="module-type-Enumerable_stringable" class="anchored"><a href="#module-type-Enumerable_stringable" class="anchor"></a><code><span><span class="keyword">module</span> <span class="keyword">type</span> Enumerable_stringable</span><span> = <a href="../../Async_command/module-type-Enumerable_stringable/index.html">Async_command.Enumerable_stringable</a></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Auto_complete" class="anchored"><a href="#module-Auto_complete" class="anchor"></a><code><span><span class="keyword">module</span> Auto_complete</span><span> = <a href="../../Async_command/Auto_complete/index.html">Async_command.Auto_complete</a></span></code></div><div class="spec-doc"><p>Specifications for command-line auto-completion.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Arg_type" class="anchored"><a href="#module-Arg_type" class="anchor"></a><code><span><span class="keyword">module</span> Arg_type</span><span> = <a href="../../Async_command/Arg_type/index.html">Async_command.Arg_type</a></span></code></div><div class="spec-doc"><p>Argument types.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Flag" class="anchored"><a href="#module-Flag" class="anchor"></a><code><span><span class="keyword">module</span> Flag</span><span> = <a href="../../Async_command/Flag/index.html">Async_command.Flag</a></span></code></div><div class="spec-doc"><p>Command-line flag specifications.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Anons" class="anchored"><a href="#module-Anons" class="anchor"></a><code><span><span class="keyword">module</span> Anons</span><span> = <a href="../../Async_command/Anons/index.html">Async_command.Anons</a></span></code></div><div class="spec-doc"><p>Anonymous command-line argument specification.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Param" class="anchored"><a href="#module-Param" class="anchor"></a><code><span><span class="keyword">module</span> Param</span><span> = <a href="../../Async_command/Param/index.html">Async_command.Param</a></span></code></div><div class="spec-doc"><p>Command-line parameter specification.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Let_syntax" class="anchored"><a href="#module-Let_syntax" class="anchor"></a><code><span><span class="keyword">module</span> Let_syntax</span><span> = <a href="../../Async_command/Let_syntax/index.html">Async_command.Let_syntax</a></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Spec" class="anchored"><a href="#module-Spec" class="anchor"></a><code><span><span class="keyword">module</span> Spec</span><span> = <a href="../../Async_command/Spec/index.html">Async_command.Spec</a></span></code></div><div class="spec-doc"><p>The old interface for command-line specifications -- <b>Do Not Use</b>.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span><span> = <a href="../../Async_command/index.html#type-t">Async_command.t</a></span></code></div><div class="spec-doc"><p>Commands which can be combined into a hierarchy of subcommands.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-basic_spec_command" class="anchored"><a href="#type-basic_spec_command" class="anchor"></a><code><span><span class="keyword">type</span> <span>('main, 'result) basic_spec_command</span></span><span> =
  <span>summary:<a href="../../../base/Base/String/index.html#type-t">Base.String.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>?readme:<span>( <span><a href="../../../base/Base/Unit/index.html#type-t">Base.Unit.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../base/Base/String/index.html#type-t">Base.String.t</a> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>( <span class="type-var">'main</span>, <span><a href="../../../base/Base/Unit/index.html#type-t">Base.Unit.t</a> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'result</span> )</span> <a href="../../Async_command/Spec/index.html#type-t">Spec.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'main</span> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-basic_spec" class="anchored"><a href="#val-basic_spec" class="anchor"></a><code><span><span class="keyword">val</span> basic_spec : <span><span>( <span class="type-var">'main</span>, <a href="../../../base/Base/Unit/index.html#type-t">Base.Unit.t</a> )</span> <a href="#type-basic_spec_command">basic_spec_command</a></span></span></code></div><div class="spec-doc"><p><code>basic_spec ~summary ?readme spec main</code> is a basic command that executes a function <code>main</code> which is passed parameters parsed from the command line according to <code>spec</code>. <code>summary</code> is to contain a short one-line description of its behavior. <code>readme</code> is to contain any longer description of its behavior that will go on that command's help screen.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-basic_command" class="anchored"><a href="#type-basic_command" class="anchor"></a><code><span><span class="keyword">type</span> <span>'result basic_command</span></span><span> =
  <span>summary:<a href="../../../base/Base/String/index.html#type-t">Base.String.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>?readme:<span>( <span><a href="../../../base/Base/Unit/index.html#type-t">Base.Unit.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../base/Base/String/index.html#type-t">Base.String.t</a> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>( <span><a href="../../../base/Base/Unit/index.html#type-t">Base.Unit.t</a> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'result</span> )</span> <a href="../../Async_command/Param/index.html#type-t">Param.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-basic" class="anchored"><a href="#val-basic" class="anchor"></a><code><span><span class="keyword">val</span> basic : <span><a href="../../../base/Base/Unit/index.html#type-t">Base.Unit.t</a> <a href="#type-basic_command">basic_command</a></span></span></code></div><div class="spec-doc"><p>Same general behavior as <code>basic_spec</code>, but takes a command line specification built up using <code>Params</code> instead of <code>Spec</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-group" class="anchored"><a href="#val-group" class="anchor"></a><code><span><span class="keyword">val</span> group : 
  <span>summary:<a href="../../../base/Base/String/index.html#type-t">Base.String.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>?readme:<span>( <span><a href="../../../base/Base/Unit/index.html#type-t">Base.Unit.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../base/Base/String/index.html#type-t">Base.String.t</a> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span>?preserve_subcommand_order:<a href="../../../base/Base/Unit/index.html#type-t">Base.Unit.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>?body:<span>( <span>path:<span><a href="../../../base/Base/String/index.html#type-t">Base.String.t</a> <a href="../../../base/Base/List/index.html#type-t">Base.List.t</a></span> <span class="arrow">&#45;&gt;</span></span> <a href="../../../base/Base/Unit/index.html#type-t">Base.Unit.t</a> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../../../base/Base/String/index.html#type-t">Base.String.t</a> * <a href="#type-t">t</a>)</span> <a href="../../../base/Base/List/index.html#type-t">Base.List.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>group ~summary subcommand_alist</code> is a compound command with named subcommands, as found in <code>subcommand_alist</code>. <code>summary</code> is to contain a short one-line description of the command group. <code>readme</code> is to contain any longer description of its behavior that will go on that command's help screen.</p><p>NOTE: subcommand names containing underscores will be rejected; use dashes instead.</p><p><code>body</code> is called when no additional arguments are passed -- in particular, when no subcommand is passed. Its <code>path</code> argument is the subcommand path by which the group command was reached.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-lazy_group" class="anchored"><a href="#val-lazy_group" class="anchor"></a><code><span><span class="keyword">val</span> lazy_group : 
  <span>summary:<a href="../../../base/Base/String/index.html#type-t">Base.String.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>?readme:<span>( <span><a href="../../../base/Base/Unit/index.html#type-t">Base.Unit.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../base/Base/String/index.html#type-t">Base.String.t</a> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span>?preserve_subcommand_order:<a href="../../../base/Base/Unit/index.html#type-t">Base.Unit.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>?body:<span>( <span>path:<span><a href="../../../base/Base/String/index.html#type-t">Base.String.t</a> <a href="../../../base/Base/List/index.html#type-t">Base.List.t</a></span> <span class="arrow">&#45;&gt;</span></span> <a href="../../../base/Base/Unit/index.html#type-t">Base.Unit.t</a> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span>(<a href="../../../base/Base/String/index.html#type-t">Base.String.t</a> * <a href="#type-t">t</a>)</span> <a href="../../../base/Base/List/index.html#type-t">Base.List.t</a></span> <a href="../../../core/Core/Lazy/index.html#type-t">Core.Lazy.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>lazy_group</code> is the same as <code>group</code>, except that the list of subcommands may be generated lazily.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-exec" class="anchored"><a href="#val-exec" class="anchor"></a><code><span><span class="keyword">val</span> exec : 
  <span>summary:<a href="../../../base/Base/String/index.html#type-t">Base.String.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>?readme:<span>( <span><a href="../../../base/Base/Unit/index.html#type-t">Base.Unit.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../base/Base/String/index.html#type-t">Base.String.t</a> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span>?child_subcommand:<span><a href="../../../base/Base/String/index.html#type-t">Base.String.t</a> <a href="../../../base/Base/List/index.html#type-t">Base.List.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span>?env:
    <span>[ <span>`Replace of <span><span>(<a href="../../../base/Base/String/index.html#type-t">Base.String.t</a> * <a href="../../../base/Base/String/index.html#type-t">Base.String.t</a>)</span> <a href="../../../base/Base/List/index.html#type-t">Base.List.t</a></span></span>
    <span><span>| `Extend</span> of <span><span>(<a href="../../../base/Base/String/index.html#type-t">Base.String.t</a> * <a href="../../../base/Base/String/index.html#type-t">Base.String.t</a>)</span> <a href="../../../base/Base/List/index.html#type-t">Base.List.t</a></span></span>
    <span><span>| `Override</span> of <span><span>(<a href="../../../base/Base/String/index.html#type-t">Base.String.t</a> * <span><a href="../../../base/Base/String/index.html#type-t">Base.String.t</a> <a href="../../../base/Base/Option/index.html#type-t">Base.Option.t</a></span>)</span> <a href="../../../base/Base/List/index.html#type-t">Base.List.t</a></span></span>
    <span><span>| `Replace_raw</span> of <span><a href="../../../base/Base/String/index.html#type-t">Base.String.t</a> <a href="../../../base/Base/List/index.html#type-t">Base.List.t</a></span></span> ]</span> <span class="arrow">&#45;&gt;</span></span>
  <span>path_to_exe:
    <span>[ <span>`Absolute of <a href="../../../base/Base/String/index.html#type-t">Base.String.t</a></span>
    <span><span>| `Relative_to_argv0</span> of <a href="../../../base/Base/String/index.html#type-t">Base.String.t</a></span>
    <span><span>| `Relative_to_me</span> of <a href="../../../base/Base/String/index.html#type-t">Base.String.t</a></span> ]</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../base/Base/Unit/index.html#type-t">Base.Unit.t</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>exec ~summary ~path_to_exe</code> runs <code>exec</code> on the executable at <code>path_to_exe</code>. If <code>path_to_exe</code> is <code>`Absolute path</code> then <code>path</code> is executed without any further qualification. If it is <code>`Relative_to_me path</code> then <code>Filename.dirname
      Sys.executable_name ^ &quot;/&quot; ^ path</code> is executed instead. All of the usual caveats about <code>Sys.executable_name</code> apply: specifically, it may only return an absolute path in Linux. On other operating systems it will return <code>Sys.argv.(0)</code>. If it is <code>`Relative_to_argv0 path</code> then <code>Sys.argv.(0) ^ &quot;/&quot; ^ path</code> is executed.</p><p>The <code>child_subcommand</code> argument allows referencing a subcommand one or more levels below the top-level of the child executable. It should <em>not</em> be used to pass flags or anonymous arguments to the child.</p><p>Care has been taken to support nesting multiple executables built with Command. In particular, recursive help and autocompletion should work as expected.</p><p>NOTE: Non-Command executables can be used with this function but will still be executed when <code>help -recursive</code> is called or autocompletion is attempted (despite the fact that neither will be particularly helpful in this case). This means that if you have a shell script called &quot;reboot-everything.sh&quot; that takes no arguments and reboots everything no matter how it is called, you shouldn't use it with <code>exec</code>.</p><p>Additionally, no loop detection is attempted, so if you nest an executable within itself, <code>help -recursive</code> and autocompletion will hang forever (although actually running the subcommand will work).</p></div></div><div class="odoc-spec"><div class="spec value" id="val-of_lazy" class="anchored"><a href="#val-of_lazy" class="anchor"></a><code><span><span class="keyword">val</span> of_lazy : <span><span><a href="#type-t">t</a> <a href="../../../core/Core/Lazy/index.html#type-t">Core.Lazy.t</a></span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>of_lazy thunk</code> constructs a lazy command that is forced only when necessary to run it or extract its shape.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-summary" class="anchored"><a href="#val-summary" class="anchor"></a><code><span><span class="keyword">val</span> summary : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../base/Base/String/index.html#type-t">Base.String.t</a></span></code></div><div class="spec-doc"><p>Extracts the summary string for a command.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Shape" class="anchored"><a href="#module-Shape" class="anchor"></a><code><span><span class="keyword">module</span> Shape</span><span> = <a href="../../Async_command/Shape/index.html">Async_command.Shape</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-exit" class="anchored"><a href="#val-exit" class="anchor"></a><code><span><span class="keyword">val</span> exit : <span><a href="../../../base/Base/Int/index.html#type-t">Base.Int.t</a> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">_</span></span></code></div><div class="spec-doc"><p>call this instead of <code>Core.exit</code> if in command-related code that you want to run in tests. For example, in the body of <code>Command.Param.no_arg_abort</code></p></div></div><div class="odoc-spec"><div class="spec module" id="module-Deprecated" class="anchored"><a href="#module-Deprecated" class="anchor"></a><code><span><span class="keyword">module</span> Deprecated</span><span> = <a href="../../Async_command/Deprecated/index.html">Async_command.Deprecated</a></span></code></div><div class="spec-doc"><p><code>Deprecated</code> should be used only by <code>Deprecated_command</code>. At some point it will go away.</p></div></div><p>Deprecated values that moved from <code>Core.Command</code> to <code>Command_unix</code>.</p><div class="odoc-spec"><div class="spec value" id="val-run" class="anchored"><a href="#val-run" class="anchor"></a><code><span><span class="keyword">val</span> run : <span>[ `Use_Command_unix ]</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Path" class="anchored"><a href="#module-Path" class="anchor"></a><code><span><span class="keyword">module</span> Path</span><span> = <a href="../../Async_command/Path/index.html">Async_command.Path</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-shape" class="anchored"><a href="#val-shape" class="anchor"></a><code><span><span class="keyword">val</span> shape : <span>[ `Use_Command_unix ]</span></span></code></div></div></div></details></div><div class="odoc-spec"><div class="spec type" id="type-with_options" class="anchored"><a href="#type-with_options" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a with_options</span></span><span> = <span>?extract_exn:bool <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-async" class="anchored"><a href="#val-async" class="anchor"></a><code><span><span class="keyword">val</span> async : <span><span><span>unit <a href="../../../async_kernel/Async_kernel/Deferred/index.html#type-t">Async_kernel.Deferred.t</a></span> <a href="#type-basic_command">basic_command</a></span> <a href="#type-with_options">with_options</a></span></span></code></div><div class="spec-doc"><p><code>async</code> is like <code>Core.Command.basic</code>, except that the main function it expects returns <code>unit Deferred.t</code>, instead of <code>unit</code>. <code>async</code> will also start the Async scheduler before main is run, and will stop the scheduler when main returns.</p><p><code>async</code> also handles top-level exceptions by wrapping the user-supplied function in a <code>Monitor.try_with</code>. If an exception is raised, it will print it to stderr and call <code>shutdown 1</code>. The <code>extract_exn</code> argument is passed along to <code>Monitor.try_with</code>; by default it is <code>false</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-async_spec" class="anchored"><a href="#val-async_spec" class="anchor"></a><code><span><span class="keyword">val</span> async_spec : 
  <span><span><span>( <span class="type-var">'a</span>, <span>unit <a href="../../../async_kernel/Async_kernel/Deferred/index.html#type-t">Async_kernel.Deferred.t</a></span> )</span> <a href="#type-basic_spec_command">basic_spec_command</a></span> <a href="#type-with_options">with_options</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-async_or_error" class="anchored"><a href="#val-async_or_error" class="anchor"></a><code><span><span class="keyword">val</span> async_or_error : 
  <span><span><span>unit <a href="../../../async_kernel/Async_kernel/Deferred/Or_error/index.html#type-t">Async_kernel.Deferred.Or_error.t</a></span> <a href="#type-basic_command">basic_command</a></span> <a href="#type-with_options">with_options</a></span></span></code></div><div class="spec-doc"><p><code>async_or_error</code> is like <code>async</code>, except that the main function it expects may return an error, in which case it prints out the error message and shuts down with exit code 1.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-async_spec_or_error" class="anchored"><a href="#val-async_spec_or_error" class="anchor"></a><code><span><span class="keyword">val</span> async_spec_or_error : 
  <span><span><span>( <span class="type-var">'a</span>, <span>unit <a href="../../../async_kernel/Async_kernel/Deferred/Or_error/index.html#type-t">Async_kernel.Deferred.Or_error.t</a></span> )</span> <a href="#type-basic_spec_command">basic_spec_command</a></span> <a href="#type-with_options">with_options</a></span></span></code></div></div><p>Staged functions allow the main function to be separated into two stages. The first part is guaranteed to run before the Async scheduler is started, and the second part will run after the scheduler is started. This is useful if the main function runs code that relies on the fact that threads have not been created yet (e.g., <code>Daemon.daemonize</code>).</p><p>As an example:</p><pre><code>let main () =
  assert (not (Scheduler.is_running ()));
  stage (fun `Scheduler_started -&gt;
    assert (Scheduler.is_running ());
    Deferred.unit
  )</code></pre><div class="odoc-spec"><div class="spec type" id="type-staged" class="anchored"><a href="#type-staged" class="anchor"></a><code><span><span class="keyword">type</span> <span>'r staged</span></span><span> = <span><span>( <span><span>[ `Scheduler_started ]</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'r</span> )</span> <a href="../../../base/Base/Staged/index.html#type-t">Core.Staged.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Staged" class="anchored"><a href="#module-Staged" class="anchor"></a><code><span><span class="keyword">module</span> Staged</span><span> = <a href="../../Async_command/Staged/index.html">Async_command.Staged</a></span></code></div></div><p>To create an <code>Arg_type.t</code> that uses auto-completion and uses Async to compute the possible completions, one should use</p><pre><code>Arg_type.create ~complete of_string</code></pre><p>where <code>complete</code> wraps its Async operations in <code>Thread_safe.block_on_async</code>. With this, the <code>complete</code> function is only called when the executable is auto-completing, not for ordinary execution. This improves performance, and also means that the Async scheduler isn't started for ordinary execution of the command, which makes it possible for the command to daemonize (which requires the scheduler to not have been started).</p></details></div></div></body></html>