<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Synchronous_time_source (async_kernel.Async_kernel.Synchronous_time_source)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">async_kernel</a> &#x00BB; <a href="../index.html">Async_kernel</a> &#x00BB; Synchronous_time_source</nav><header class="odoc-preamble"><h1>Module <code><span>Async_kernel.Synchronous_time_source</span></code></h1><p>A synchronous version of <code>Async_kernel.Time_source</code>. <code>advance_by_alarms</code> runs alarms immediately, rather than enqueueing Async jobs.</p><p><code>Synchronous_time_source</code> is a wrapper around <code>Timing_wheel</code>. One difference is that <code>Synchronous_time_source</code> alarms fire in non-decreasing time order, whereas in <code>Timing_wheel</code> that is only true for alarms in different time intervals as determined by <code>alarm_precision</code>.</p></header><nav class="odoc-toc"><ul><li><a href="#for-scheduler-implementors">For Scheduler Implementors</a></li></ul></nav><div class="odoc-content"><div class="odoc-spec"><div class="spec module" id="module-T1" class="anchored"><a href="#module-T1" class="anchor"></a><code><span><span class="keyword">module</span> <a href="T1/index.html">T1</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Read_write" class="anchored"><a href="#module-Read_write" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Read_write/index.html">Read_write</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Id" class="anchored"><a href="#module-Id" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Id/index.html">Id</a></span><span> : <a href="../../../core/Core/Unique_id/module-type-Id/index.html">Core.Unique_id.Id</a></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span><span> = <span><a href="../../../core/Core/index.html#type-read">Core.read</a> <a href="T1/index.html#type-t">T1.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-sexp_of_t" class="anchored"><a href="#val-sexp_of_t" class="anchor"></a><code><span><span class="keyword">val</span> sexp_of_t : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Sexplib0</span>.Sexp.t</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-invariant_with_jobs" class="anchored"><a href="#val-invariant_with_jobs" class="anchor"></a><code><span><span class="keyword">val</span> invariant_with_jobs : 
  <span>job:
    <span><span><span><span>( <span class="xref-unresolved">Async_kernel__Types.Execution_context.t</span>,
      <span><span class="xref-unresolved">Stdlib</span>.Obj.t <span class="arrow">&#45;&gt;</span></span>
      unit,
      <span class="xref-unresolved">Stdlib</span>.Obj.t )</span>
      <a href="../../../core_kernel/Tuple_pool/Slots/index.html#type-t3">Tuple_pool.Slots.t3</a></span>
      <a href="../../../core_kernel/Tuple_pool/Pointer/index.html#type-t">Tuple_pool.Pointer.t</a></span>
      <a href="../../../base/Base/Invariant/index.html#type-t">Core.Invariant.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <a href="../../../base/Base/Invariant/index.html#type-t">Core.Invariant.t</a></span></span></code></div></div><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <a href="../../../base/Base/Invariant/module-type-S/index.html">Core.Invariant.S</a> <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="../../../base/Base/Invariant/module-type-S/index.html#type-t">t</a> := <a href="#type-t">t</a></span></span></code></summary><div class="odoc-spec"><div class="spec value" id="val-invariant" class="anchored"><a href="#val-invariant" class="anchor"></a><code><span><span class="keyword">val</span> invariant : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div></details></div><div class="odoc-spec"><div class="spec value" id="val-id" class="anchored"><a href="#val-id" class="anchor"></a><code><span><span class="keyword">val</span> id : <span><span><span class="type-var">_</span> <a href="T1/index.html#type-t">T1.t</a></span> <span class="arrow">&#45;&gt;</span></span> <a href="Id/index.html#type-t">Id.t</a></span></code></div><div class="spec-doc"><p><code>id t</code> returns a unique, consistent identifier which can be used e.g. as a map or hash table key.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-read_only" class="anchored"><a href="#val-read_only" class="anchor"></a><code><span><span class="keyword">val</span> read_only : <span><span><span>[&gt; <a href="../../../core/Core/index.html#type-read">Core.read</a> ]</span> <a href="T1/index.html#type-t">T1.t</a></span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-callback" class="anchored"><a href="#type-callback" class="anchor"></a><code><span><span class="keyword">type</span> callback</span><span> = <span>unit <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-create" class="anchored"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : 
  <span>?timing_wheel_config:<a href="../../../core_kernel/Timing_wheel/Config/index.html#type-t">Timing_wheel.Config.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>now:<a href="../../../core/Core/Int63/index.html#type-t">Core.Int63.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../core/Core/index.html#type-read_write">Core.read_write</a> <a href="T1/index.html#type-t">T1.t</a></span></span></code></div><div class="spec-doc"><p><code>create ~now ()</code> creates a new time source. The default <code>timing_wheel_config</code> has 100 microsecond precision, with levels of &gt;1s, &gt;1m, &gt;1h, &gt;1d. The <code>timing_wheel_config</code> is used to tune performance; configuration does not affect the fact that alarms fire in non-decreasing time order.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-alarm_precision" class="anchored"><a href="#val-alarm_precision" class="anchor"></a><code><span><span class="keyword">val</span> alarm_precision : <span><span><span>[&gt; <a href="../../../core/Core/index.html#type-read">Core.read</a> ]</span> <a href="T1/index.html#type-t">T1.t</a></span> <span class="arrow">&#45;&gt;</span></span> <a href="../../../core/Core/Int63/index.html#type-t">Core.Int63.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-is_wall_clock" class="anchored"><a href="#val-is_wall_clock" class="anchor"></a><code><span><span class="keyword">val</span> is_wall_clock : <span><span><span>[&gt; <a href="../../../core/Core/index.html#type-read">Core.read</a> ]</span> <a href="T1/index.html#type-t">T1.t</a></span> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>is_wall_clock</code> reports whether this time source represents 'wall clock' time, or some alternate source of time.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-now" class="anchored"><a href="#val-now" class="anchor"></a><code><span><span class="keyword">val</span> now : <span><span><span>[&gt; <a href="../../../core/Core/index.html#type-read">Core.read</a> ]</span> <a href="T1/index.html#type-t">T1.t</a></span> <span class="arrow">&#45;&gt;</span></span> <a href="../../../core/Core/Int63/index.html#type-t">Core.Int63.t</a></span></code></div><div class="spec-doc"><p>The behavior of <code>now</code> is special for <code>wall_clock ()</code>; it always calls <code>Time_ns.now
    ()</code>, so it can return times that the time source has not yet been advanced to.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-timing_wheel_now" class="anchored"><a href="#val-timing_wheel_now" class="anchor"></a><code><span><span class="keyword">val</span> timing_wheel_now : <span><span><span>[&gt; <a href="../../../core/Core/index.html#type-read">Core.read</a> ]</span> <a href="T1/index.html#type-t">T1.t</a></span> <span class="arrow">&#45;&gt;</span></span> <a href="../../../core/Core/Int63/index.html#type-t">Core.Int63.t</a></span></code></div><div class="spec-doc"><p>Removes the special behavior of <code>now</code> for <code>wall_clock ()</code>; it always returns the timing wheel's notion of now, which means that the following inequality always holds: <code>timing_wheel_now () &lt;= now ()</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-run_at" class="anchored"><a href="#val-run_at" class="anchor"></a><code><span><span class="keyword">val</span> run_at : <span><span><span>[&gt; <a href="../../../core/Core/index.html#type-read">Core.read</a> ]</span> <a href="T1/index.html#type-t">T1.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../core/Core/Int63/index.html#type-t">Core.Int63.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-callback">callback</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>run_at t at f</code> schedules an alarm that will run <code>f</code> during the next subsequent <code>advance_by_alarms t ~to_</code> that causes <code>now t &gt;= at</code>. If <code>at &lt;= now t</code>, then <code>f</code> will to run at the next call to <code>advance_by_alarms</code>. <code>f</code> is allowed to do all <code>Synchronous_time_source</code> operations except for <code>advance_by_alarms</code> (because <code>f</code> is already running during <code>advance_by_alarms</code>. Adding alarms is not zero-alloc and the underlying events live in the OCaml heap.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-run_after" class="anchored"><a href="#val-run_after" class="anchor"></a><code><span><span class="keyword">val</span> run_after : <span><span><span>[&gt; <a href="../../../core/Core/index.html#type-read">Core.read</a> ]</span> <a href="T1/index.html#type-t">T1.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../core/Core/Int63/index.html#type-t">Core.Int63.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-callback">callback</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>run_after t span f</code> is <code>run_at t (now t + span) f</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-run_at_intervals" class="anchored"><a href="#val-run_at_intervals" class="anchor"></a><code><span><span class="keyword">val</span> run_at_intervals : <span><span><span>[&gt; <a href="../../../core/Core/index.html#type-read">Core.read</a> ]</span> <a href="T1/index.html#type-t">T1.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../core/Core/Int63/index.html#type-t">Core.Int63.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-callback">callback</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>run_at_intervals t span f</code> schedules <code>f</code> to run at intervals <code>now t + k * span</code>, for k = 0, 1, 2, etc. <code>run_at_intervals</code> raises if <code>span &lt; alarm_precision t</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-max_allowed_alarm_time" class="anchored"><a href="#val-max_allowed_alarm_time" class="anchor"></a><code><span><span class="keyword">val</span> max_allowed_alarm_time : <span><span><span>[&gt; <a href="../../../core/Core/index.html#type-read">Core.read</a> ]</span> <a href="T1/index.html#type-t">T1.t</a></span> <span class="arrow">&#45;&gt;</span></span> <a href="../../../core/Core/Int63/index.html#type-t">Core.Int63.t</a></span></code></div><div class="spec-doc"><p><code>max_allowed_alarm_time t</code> returns the greatest <code>at</code> that can be supplied to <code>add</code>. <code>max_allowed_alarm_time</code> is not constant; its value increases as <code>now t</code> increases.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-duration_of" class="anchored"><a href="#val-duration_of" class="anchor"></a><code><span><span class="keyword">val</span> duration_of : <span><span><span>[&gt; <a href="../../../core/Core/index.html#type-read">Core.read</a> ]</span> <a href="T1/index.html#type-t">T1.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>( <span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span> )</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span> * <a href="../../../core/Core/Int63/index.html#type-t">Core.Int63.t</a></span></code></div><div class="spec-doc"><p><code>duration_of t f</code> invokes <code>f</code> and measures how long it takes for the call to finish.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Event" class="anchored"><a href="#module-Event" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Event/index.html">Event</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-default_timing_wheel_config" class="anchored"><a href="#val-default_timing_wheel_config" class="anchor"></a><code><span><span class="keyword">val</span> default_timing_wheel_config : <a href="../../../core_kernel/Timing_wheel/Config/index.html#type-t">Timing_wheel.Config.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-wall_clock" class="anchored"><a href="#val-wall_clock" class="anchor"></a><code><span><span class="keyword">val</span> wall_clock : <span>unit <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p>A time source with <code>now t</code> given by wall-clock time (i.e. <code>Time_ns.now</code>), and automatically advanced at the start of each Async cycle. The wall clock uses the same timing wheel as that used by the Async scheduler, and is hence similarly affected by the <code>ASYNC_CONFIG</code> environment variable.</p></div></div><h3 id="for-scheduler-implementors"><a href="#for-scheduler-implementors" class="anchor"></a>For Scheduler Implementors</h3><div class="odoc-spec"><div class="spec value" id="val-length" class="anchored"><a href="#val-length" class="anchor"></a><code><span><span class="keyword">val</span> length : <span><span><span>[&gt; <a href="../../../core/Core/index.html#type-write">Core.write</a> ]</span> <a href="T1/index.html#type-t">T1.t</a></span> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>length t</code> returns the number of alarms in the underlying <code>Timing_wheel</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-next_alarm_runs_at" class="anchored"><a href="#val-next_alarm_runs_at" class="anchor"></a><code><span><span class="keyword">val</span> next_alarm_runs_at : <span><span><span>[&gt; <a href="../../../core/Core/index.html#type-write">Core.write</a> ]</span> <a href="T1/index.html#type-t">T1.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../core/Core/Int63/index.html#type-t">Core.Int63.t</a> option</span></span></code></div><div class="spec-doc"><p><code>next_alarm_runs_at t</code> returns a time to which the clock can be advanced such that an alarm will fire, or <code>None</code> if <code>t</code> has no alarms that can ever fire.</p><p>Note that this is not necessarily the minimum such time, but it's within <code>alarm_precision</code> of that.</p><p>If an alarm was already fired (e.g. because it was scheduled in the past), but its callbacks were not run yet, this function returns <code>Some now</code>, to indicate that a trivial time advancement is sufficient for those to run.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-next_alarm_fires_at" class="anchored"><a href="#val-next_alarm_fires_at" class="anchor"></a><code><span><span class="keyword">val</span> next_alarm_fires_at : <span><span><span>[&gt; <a href="../../../core/Core/index.html#type-write">Core.write</a> ]</span> <a href="T1/index.html#type-t">T1.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../core/Core/Int63/index.html#type-t">Core.Int63.t</a> option</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-advance_by_alarms" class="anchored"><a href="#val-advance_by_alarms" class="anchor"></a><code><span><span class="keyword">val</span> advance_by_alarms : 
  <span><span><span>[&gt; <a href="../../../core/Core/index.html#type-write">Core.write</a> ]</span> <a href="T1/index.html#type-t">T1.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span>to_:<a href="../../../core/Core/Int63/index.html#type-t">Core.Int63.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <a href="../../../core/Core/Or_error/index.html#type-t">Core.Or_error.t</a></span></span></code></div><div class="spec-doc"><p><code>advance_by_alarms t ~to_</code> advances <code>t</code>'s time to <code>to_</code>, running callbacks for all alarms in <code>t</code> whose <code>at &lt;= to_</code>. Callbacks run in nondecreasing order of <code>at</code>. If <code>to_ &lt;= now t</code>, then <code>now t</code> does not change (and in particular does not go backward), but alarms with <code>at &lt;= to_</code> may still may fire.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-advance_by_max_alarms_in_each_timing_wheel_interval" class="anchored"><a href="#val-advance_by_max_alarms_in_each_timing_wheel_interval" class="anchor"></a><code><span><span class="keyword">val</span> advance_by_max_alarms_in_each_timing_wheel_interval : 
  <span><span><span>[&gt; <a href="../../../core/Core/index.html#type-write">Core.write</a> ]</span> <a href="T1/index.html#type-t">T1.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span>to_:<a href="../../../core/Core/Int63/index.html#type-t">Core.Int63.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <a href="../../../core/Core/Or_error/index.html#type-t">Core.Or_error.t</a></span></span></code></div><div class="spec-doc"><p>A version of <code>advance_by_alarms</code> with some weird behavior caused by timing wheel <code>alarm_precision</code>: if there are multiple alarms within the same timing_wheel precision bucket, then this function fires them all at the same time (when the last of the bunch of alarms is supposed to fire). The time <code>to_</code> counts as an alarm for this purpose. (any alarms in the same bucket as <code>to_</code> will be fired at time <code>to_</code>.</p><p><code>advance_by_alarms</code> has no such weirdness, and fires every alarm at the time that alarm is scheduled.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-advance_directly" class="anchored"><a href="#val-advance_directly" class="anchor"></a><code><span><span class="keyword">val</span> advance_directly : 
  <span><span><span>[&gt; <a href="../../../core/Core/index.html#type-write">Core.write</a> ]</span> <a href="T1/index.html#type-t">T1.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span>to_:<a href="../../../core/Core/Int63/index.html#type-t">Core.Int63.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <a href="../../../core/Core/Or_error/index.html#type-t">Core.Or_error.t</a></span></span></code></div><div class="spec-doc"><p>Instead of <code>advance_directly</code>, you probably should use <code>advance_by_alarms</code>. <code>advance_directly t ~to_</code> advances the clock directly to <code>to_</code>, whereas <code>advance_by_alarms</code> advances the clock in steps, to each intervening alarm. In particular periodic/rearming timers will fire at most twice.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-max_alarm_time_in_min_timing_wheel_interval" class="anchored"><a href="#val-max_alarm_time_in_min_timing_wheel_interval" class="anchor"></a><code><span><span class="keyword">val</span> max_alarm_time_in_min_timing_wheel_interval : 
  <span><span><span>[&gt; <a href="../../../core/Core/index.html#type-write">Core.write</a> ]</span> <a href="T1/index.html#type-t">T1.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../core/Core/Int63/index.html#type-t">Core.Int63.t</a> option</span></span></code></div><div class="spec-doc"><p>This value is close to <code>next_alarm_fires_at</code> but differs from it by at most <code>alarm_precision</code>. Requires a more expensive iteration of alarms.</p><p>This is a closer approximation of the minimum time at which an alarm will fire, but it's still not there (you need min_alarm_time_... for that).</p></div></div><div class="odoc-spec"><div class="spec value" id="val-has_events_to_run" class="anchored"><a href="#val-has_events_to_run" class="anchor"></a><code><span><span class="keyword">val</span> has_events_to_run : <span><span><span>[&gt; <a href="../../../core/Core/index.html#type-write">Core.write</a> ]</span> <a href="T1/index.html#type-t">T1.t</a></span> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Returns true iff there is work to do without advancing time further. (This can be caused by scheduling events in the past, or starting a recurring event.)</p></div></div></div></body></html>