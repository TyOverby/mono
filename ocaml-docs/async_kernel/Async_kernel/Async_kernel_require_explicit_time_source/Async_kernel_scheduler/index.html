<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Async_kernel_scheduler (async_kernel.Async_kernel.Async_kernel_require_explicit_time_source.Async_kernel_scheduler)</title><link rel="stylesheet" href="../../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">async_kernel</a> &#x00BB; <a href="../../index.html">Async_kernel</a> &#x00BB; <a href="../index.html">Async_kernel_require_explicit_time_source</a> &#x00BB; Async_kernel_scheduler</nav><header class="odoc-preamble"><h1>Module <code><span>Async_kernel_require_explicit_time_source.Async_kernel_scheduler</span></code></h1></header><div class="odoc-content"><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <span class="keyword">module</span> <span class="keyword">type</span> <span class="keyword">of</span> <span class="keyword">struct</span> <span class="keyword">include</span> <a href="../../Async_kernel_scheduler/index.html">Async_kernel_scheduler</a> <span class="keyword">end</span></span></code></summary><div class="odoc-spec"><div class="spec type" id="type-with_options" class="anchored"><a href="#type-with_options" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a with_options</span></span><span> = <span>?monitor:<a href="../../Monitor/index.html#type-t">Monitor.t</a> <span class="arrow">&#45;&gt;</span></span> <span>?priority:<a href="../../Priority/index.html#type-t">Priority.t</a> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-current_execution_context" class="anchored"><a href="#val-current_execution_context" class="anchor"></a><code><span><span class="keyword">val</span> current_execution_context : <span>unit <span class="arrow">&#45;&gt;</span></span> <a href="../../Execution_context/index.html#type-t">Execution_context.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-within_context" class="anchored"><a href="#val-within_context" class="anchor"></a><code><span><span class="keyword">val</span> within_context : 
  <span><a href="../../Execution_context/index.html#type-t">Execution_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>( <span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>( <span class="type-var">'a</span>, unit )</span> <a href="../../../../core/Core/Result/index.html#type-t">Core.Result.t</a></span></span></code></div><div class="spec-doc"><p><code>within_context context f</code> runs <code>f ()</code> right now with the specified execution context. If <code>f</code> raises, then the exception is sent to the monitor of <code>context</code>, and <code>Error ()</code> is returned.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-within'" class="anchored"><a href="#val-within'" class="anchor"></a><code><span><span class="keyword">val</span> within' : <span><span>( <span><span>( <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="../../Deferred/index.html#type-t">Deferred.t</a></span> )</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="../../Deferred/index.html#type-t">Deferred.t</a></span> )</span> <a href="#type-with_options">with_options</a></span></span></code></div><div class="spec-doc"><p><code>within' f ~monitor ~priority</code> runs <code>f ()</code> right now, with the specified block group, monitor, and priority set as specified. They will be reset to their original values when <code>f</code> returns. If <code>f</code> raises, then the result of <code>within'</code> will never become determined, but the exception will end up in the specified monitor.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-within" class="anchored"><a href="#val-within" class="anchor"></a><code><span><span class="keyword">val</span> within : <span><span>( <span><span>( <span>unit <span class="arrow">&#45;&gt;</span></span> unit )</span> <span class="arrow">&#45;&gt;</span></span> unit )</span> <a href="#type-with_options">with_options</a></span></span></code></div><div class="spec-doc"><p><code>within</code> is like <code>within'</code>, but doesn't require the thunk to return a deferred.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-within_v" class="anchored"><a href="#val-within_v" class="anchor"></a><code><span><span class="keyword">val</span> within_v : <span><span>( <span><span>( <span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span> )</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> option</span> )</span> <a href="#type-with_options">with_options</a></span></span></code></div><div class="spec-doc"><p><code>within_v</code> is like <code>within</code>, but allows a value to be returned by <code>f</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-with_local" class="anchored"><a href="#val-with_local" class="anchor"></a><code><span><span class="keyword">val</span> with_local : <span><span><span class="type-var">'a</span> <a href="../../../../core/Core/Type_equal/Id/index.html#type-t">Core.Univ_map.Key.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> option</span> <span class="arrow">&#45;&gt;</span></span> <span>f:<span>( <span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span> )</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span></span></code></div><div class="spec-doc"><p><code>with_local key value ~f</code>, when run in the current execution context, <code>e</code>, runs <code>f</code> right now in a new execution context, <code>e'</code>, that is identical to <code>e</code> except that <code>find_local key = value</code>. As usual, <code>e'</code> will be in effect in asynchronous computations started by <code>f</code>. When <code>with_local</code> returns, the execution context is restored to <code>e</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-find_local" class="anchored"><a href="#val-find_local" class="anchor"></a><code><span><span class="keyword">val</span> find_local : <span><span><span class="type-var">'a</span> <a href="../../../../core/Core/Type_equal/Id/index.html#type-t">Core.Univ_map.Key.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> option</span></span></code></div><div class="spec-doc"><p><code>find_local key</code> returns the value associated to <code>key</code> in the current execution context.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-schedule'" class="anchored"><a href="#val-schedule'" class="anchor"></a><code><span><span class="keyword">val</span> schedule' : <span><span>( <span><span>( <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="../../Deferred/index.html#type-t">Deferred.t</a></span> )</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="../../Deferred/index.html#type-t">Deferred.t</a></span> )</span> <a href="#type-with_options">with_options</a></span></span></code></div><div class="spec-doc"><p>Just like <code>within'</code>, but instead of running the thunk right now, adds it to the Async queue to be run with other Async jobs.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-schedule" class="anchored"><a href="#val-schedule" class="anchor"></a><code><span><span class="keyword">val</span> schedule : <span><span>( <span><span>( <span>unit <span class="arrow">&#45;&gt;</span></span> unit )</span> <span class="arrow">&#45;&gt;</span></span> unit )</span> <a href="#type-with_options">with_options</a></span></span></code></div><div class="spec-doc"><p>Just like <code>schedule'</code>, but doesn't require the thunk to return a deferred.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-enqueue_job" class="anchored"><a href="#val-enqueue_job" class="anchor"></a><code><span><span class="keyword">val</span> enqueue_job : <span><a href="../../Execution_context/index.html#type-t">Execution_context.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>( <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> unit )</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>eneque_job execution_context.t f a</code> enqueues into the scheduler's job queue a job that will run <code>f a</code> in <code>execution_context</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-thread_safe_enqueue_job" class="anchored"><a href="#val-thread_safe_enqueue_job" class="anchor"></a><code><span><span class="keyword">val</span> thread_safe_enqueue_job : 
  <span><a href="../../Execution_context/index.html#type-t">Execution_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>( <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> unit )</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>thread_safe_enqueue_job</code> is like <code>enqueue_job</code>, except it is for use from a thread that doesn't hold the Async lock.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-preserve_execution_context" class="anchored"><a href="#val-preserve_execution_context" class="anchor"></a><code><span><span class="keyword">val</span> preserve_execution_context : <span><span>( <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> unit )</span> <span class="arrow">&#45;&gt;</span></span> <span><span>( <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> unit )</span> <a href="../../../../base/Base/Staged/index.html#type-t">Core.Staged.t</a></span></span></code></div><div class="spec-doc"><p><code>preserve_execution_context t f</code> saves the current execution context and returns a function <code>g</code> such that <code>g a</code> runs <code>f a</code> in the saved execution context. <code>g a</code> becomes determined when <code>f a</code> becomes determined.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-preserve_execution_context'" class="anchored"><a href="#val-preserve_execution_context'" class="anchor"></a><code><span><span class="keyword">val</span> preserve_execution_context' : 
  <span><span>( <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <a href="../../Deferred/index.html#type-t">Deferred.t</a></span> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>( <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <a href="../../Deferred/index.html#type-t">Deferred.t</a></span> )</span> <a href="../../../../base/Base/Staged/index.html#type-t">Core.Staged.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-cycle_times" class="anchored"><a href="#val-cycle_times" class="anchor"></a><code><span><span class="keyword">val</span> cycle_times : <span>unit <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../../core/Core/Time/Span/index.html#type-t">Core.Time.Span.t</a> <a href="../../Tail/Stream/index.html#type-t">Tail.Stream.t</a></span></span></code></div><div class="spec-doc"><p><code>cycle_times ()</code> returns a stream that is extended with an element at the start of each Async cycle, with the amount of time that the previous cycle took, as determined by calls to <code>Time.now</code> at the beginning and end of the cycle.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-cycle_times_ns" class="anchored"><a href="#val-cycle_times_ns" class="anchor"></a><code><span><span class="keyword">val</span> cycle_times_ns : <span>unit <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../../core/Core/Int63/index.html#type-t">Core.Int63.t</a> <a href="../../Tail/Stream/index.html#type-t">Tail.Stream.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-last_cycle_time" class="anchored"><a href="#val-last_cycle_time" class="anchor"></a><code><span><span class="keyword">val</span> last_cycle_time : <span>unit <span class="arrow">&#45;&gt;</span></span> <a href="../../../../core/Core/Int63/index.html#type-t">Core.Int63.t</a></span></code></div><div class="spec-doc"><p><code>last_cycle_time</code> returns the time spent in the most recently completed cycle.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-long_cycles" class="anchored"><a href="#val-long_cycles" class="anchor"></a><code><span><span class="keyword">val</span> long_cycles : <span>at_least:<a href="../../../../core/Core/Int63/index.html#type-t">Core.Int63.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../../core/Core/Int63/index.html#type-t">Core.Int63.t</a> <a href="../../Tail/Stream/index.html#type-t">Tail.Stream.t</a></span></span></code></div><div class="spec-doc"><p><code>long_cycles ~at_least</code> returns a stream of cycles whose duration is at least <code>at_least</code>. <code>long_cycles</code> is more efficient than <code>cycle_times</code> because it only allocates a stream entry when there is a long cycle, rather than on every cycle.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-cycle_count" class="anchored"><a href="#val-cycle_count" class="anchor"></a><code><span><span class="keyword">val</span> cycle_count : <span>unit <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>cycle_count ()</code> returns the total number of Async cycles that have happened.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-total_cycle_time" class="anchored"><a href="#val-total_cycle_time" class="anchor"></a><code><span><span class="keyword">val</span> total_cycle_time : <span>unit <span class="arrow">&#45;&gt;</span></span> <a href="../../../../core/Core/Int63/index.html#type-t">Core.Int63.t</a></span></code></div><div class="spec-doc"><p><code>total_cycle_time ()</code> returns the total (wall) time spent executing jobs in Async cycles.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-event_precision" class="anchored"><a href="#val-event_precision" class="anchor"></a><code><span><span class="keyword">val</span> event_precision : <span>unit <span class="arrow">&#45;&gt;</span></span> <a href="../../../../core/Core/Time/Span/index.html#type-t">Core.Time.Span.t</a></span></code></div><div class="spec-doc"><p>The <code>alarm_precision</code> of the timing-wheel used to implement Async's <code>Clock</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-event_precision_ns" class="anchored"><a href="#val-event_precision_ns" class="anchor"></a><code><span><span class="keyword">val</span> event_precision_ns : <span>unit <span class="arrow">&#45;&gt;</span></span> <a href="../../../../core/Core/Int63/index.html#type-t">Core.Int63.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-force_current_cycle_to_end" class="anchored"><a href="#val-force_current_cycle_to_end" class="anchor"></a><code><span><span class="keyword">val</span> force_current_cycle_to_end : <span>unit <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>force_current_cycle_to_end ()</code> causes no more normal priority jobs to run in the current cycle, and for the end-of-cycle jobs (i.e., writes) to run, and then for the cycle to end.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-set_max_num_jobs_per_priority_per_cycle" class="anchored"><a href="#val-set_max_num_jobs_per_priority_per_cycle" class="anchor"></a><code><span><span class="keyword">val</span> set_max_num_jobs_per_priority_per_cycle : <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_max_num_jobs_per_priority_per_cycle int</code> sets the maximum number of jobs that will be done at each priority within each Async cycle. The default is <code>500</code>. <code>max_num_jobs_per_priority_per_cycle</code> retrieves the current value.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-max_num_jobs_per_priority_per_cycle" class="anchored"><a href="#val-max_num_jobs_per_priority_per_cycle" class="anchor"></a><code><span><span class="keyword">val</span> max_num_jobs_per_priority_per_cycle : <span>unit <span class="arrow">&#45;&gt;</span></span> int</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-set_record_backtraces" class="anchored"><a href="#val-set_record_backtraces" class="anchor"></a><code><span><span class="keyword">val</span> set_record_backtraces : <span>bool <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_record_backtraces do_record</code> sets whether Async should keep in the execution context the history of stack backtraces (obtained via <code>Backtrace.get</code>) that led to the current job. If an Async job has an unhandled exception, this backtrace history will be recorded in the exception. In particular the history will appear in an unhandled exception that reaches the main monitor. This can have a substantial performance impact, both in running time and space usage.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-yield" class="anchored"><a href="#val-yield" class="anchor"></a><code><span><span class="keyword">val</span> yield : <span>unit <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../../Deferred/index.html#type-t">Deferred.t</a></span></span></code></div><div class="spec-doc"><p><code>yield ()</code> returns a deferred that becomes determined after the current cycle completes. This can be useful to improve fairness by <code>yield</code>ing within a computation to give other jobs a chance to run.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-yield_until_no_jobs_remain" class="anchored"><a href="#val-yield_until_no_jobs_remain" class="anchor"></a><code><span><span class="keyword">val</span> yield_until_no_jobs_remain : 
  <span>?may_return_immediately:bool <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span>unit <a href="../../Deferred/index.html#type-t">Deferred.t</a></span></span></code></div><div class="spec-doc"><p><code>yield_until_no_jobs_remain ()</code> returns a deferred that becomes determined the next time Async's job queue is empty. This is useful in tests when one needs to wait for the completion of all the jobs based on what's in the queue, when those jobs might create other jobs -- without depending on I/O or the passage of wall-clock time.</p><p><code>may_return_immediately</code> determines how <code>yield_until_no_jobs_remain</code> behaves if the job queue is currently empty. If <code>may_return_immediately = true</code>, then <code>yield_until_no_jobs_remain</code> will <code>return ()</code>. If <code>may_return_immediately = false</code>, then <code>yield_until_no_jobs_remain</code>'s result will become determined after the next Async cycle. We hope to someday change the default <code>may_return_immediately</code> from <code>false</code> to <code>true</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-yield_every" class="anchored"><a href="#val-yield_every" class="anchor"></a><code><span><span class="keyword">val</span> yield_every : <span>n:int <span class="arrow">&#45;&gt;</span></span> <span><span>( <span>unit <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../../Deferred/index.html#type-t">Deferred.t</a></span> )</span> <a href="../../../../base/Base/Staged/index.html#type-t">Core.Staged.t</a></span></span></code></div><div class="spec-doc"><p><code>yield_every ~n</code> returns a function that will act as <code>yield</code> every <code>n</code> calls and as <code>return ()</code> the rest of the time. This is useful for improving fairness in circumstances where you don't have good control of the batch size, but can insert a deferred into every iteration.</p><p><code>yield_every</code> raises if <code>n &lt;= 0</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-num_jobs_run" class="anchored"><a href="#val-num_jobs_run" class="anchor"></a><code><span><span class="keyword">val</span> num_jobs_run : <span>unit <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>num_jobs_run ()</code> returns the number of jobs that have been run since starting. The returned value includes the currently running job.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-num_pending_jobs" class="anchored"><a href="#val-num_pending_jobs" class="anchor"></a><code><span><span class="keyword">val</span> num_pending_jobs : <span>unit <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>num_pending_jobs</code> returns the number of jobs that are queued to run by the scheduler.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Expert" class="anchored"><a href="#module-Expert" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Expert/index.html">Expert</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Private" class="anchored"><a href="#module-Private" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Private/index.html">Private</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Internal to Async -- see <code>Async_unix</code>.Scheduler for the public API.</p></div></div></details></div><div class="odoc-spec"><div class="spec value" id="val-cycle_start" class="anchored"><a href="#val-cycle_start" class="anchor"></a><code><span><span class="keyword">val</span> cycle_start : <span>unit <span class="arrow">&#45;&gt;</span></span> <a href="../Time/index.html#type-t">Time.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-cycle_start_ns" class="anchored"><a href="#val-cycle_start_ns" class="anchor"></a><code><span><span class="keyword">val</span> cycle_start_ns : <span>unit <span class="arrow">&#45;&gt;</span></span> <a href="../Time_ns/index.html#type-t">Time_ns.t</a></span></code></div></div></div></body></html>