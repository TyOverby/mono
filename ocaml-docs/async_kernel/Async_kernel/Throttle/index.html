<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Throttle (async_kernel.Async_kernel.Throttle)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">async_kernel</a> &#x00BB; <a href="../index.html">Async_kernel</a> &#x00BB; Throttle</nav><header class="odoc-preamble"><h1>Module <code><span>Async_kernel.Throttle</span></code></h1><p>A way to limit the number of concurrent computations.</p><p>A throttle is essentially a pipe to which one can feed jobs.</p><p>A throttle schedules asynchronous jobs so that at any point in time no more than <code>max_concurrent_jobs</code> jobs are running. A job <code>f</code> is considered to be running from the time <code>f ()</code> is executed until the deferred returned by <code>f ()</code> becomes determined, or <code>f ()</code> raises. The throttle initiates jobs on a first-come first-served basis.</p><p>One can use <code>create_with</code> to create a throttle with &quot;resources&quot; that one would like to make available to concurrent jobs and to guarantee that different jobs access different resources.</p><p>A throttle is killed if one of its jobs throws an exception, and the throttle has <code>continue_on_error = false</code>. A throttle can also be explicitly <code>kill</code>ed. If a throttle is killed, then all jobs in it that haven't yet started are aborted, i.e., they will not start and will become determined with <code>`Aborted</code>. Jobs that had already started will continue, and return <code>`Ok</code> or <code>`Raised</code> as usual when they finish. Jobs enqueued into a killed throttle will be immediately aborted.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec module" id="module-T2" class="anchored"><a href="#module-T2" class="anchor"></a><code><span><span class="keyword">module</span> <a href="T2/index.html">T2</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>We use a phantom type to distinguish between throttles, which have <code>max_concurrent_jobs &gt;= 1</code>, and sequencers, which have <code>max_concurrent_jobs = 1</code>. All operations are available on both. We make the distinction because it is sometimes useful to know from the type of a throttle that it is a sequencer and that at most one job can be running at a time.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a t</span></span><span> = <span><span>( <span class="type-var">'a</span>, <span>[ `throttle ]</span> )</span> <a href="T2/index.html#type-t">T2.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-sexp_of_t" class="anchored"><a href="#val-sexp_of_t" class="anchor"></a><code><span><span class="keyword">val</span> sexp_of_t : <span><span>( <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Sexplib0</span>.Sexp.t )</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Sexplib0</span>.Sexp.t</span></code></div></div><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <a href="../../../base/Base/Invariant/module-type-S1/index.html">Core.Invariant.S1</a> <span class="keyword">with</span> <span><span class="keyword">type</span> <span>'a <a href="../../../base/Base/Invariant/module-type-S1/index.html#type-t">t</a></span> := <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></span></code></summary><div class="odoc-spec"><div class="spec value" id="val-invariant" class="anchored"><a href="#val-invariant" class="anchor"></a><code><span><span class="keyword">val</span> invariant : <span><span>( <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> unit )</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div></details></div><div class="odoc-spec"><div class="spec value" id="val-create" class="anchored"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : <span>continue_on_error:bool <span class="arrow">&#45;&gt;</span></span> <span>max_concurrent_jobs:int <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>create ~continue_on_error ~max_concurrent_jobs</code> returns a throttle that will run up to <code>max_concurrent_jobs</code> concurrently. If some job raises an exception, then the throttle will be killed, unless <code>continue_on_error</code> is true.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-create_with" class="anchored"><a href="#val-create_with" class="anchor"></a><code><span><span class="keyword">val</span> create_with : <span>continue_on_error:bool <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>create_with ~continue_on_error job_resources</code> returns a throttle that will run up to <code>List.length job_resources</code> concurrently, and will ensure that all running jobs are supplied distinct elements of <code>job_resources</code>.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-outcome" class="anchored"><a href="#type-outcome" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a outcome</span></span><span> = </span><span>[ </span></code><table><tr id="type-outcome.Ok" class="anchored"><td class="def constructor"><a href="#type-outcome.Ok" class="anchor"></a><code><span>| </span></code><code><span>`Ok <span class="keyword">of</span> <span class="type-var">'a</span></span></code></td></tr><tr id="type-outcome.Aborted" class="anchored"><td class="def constructor"><a href="#type-outcome.Aborted" class="anchor"></a><code><span>| </span></code><code><span>`Aborted</span></code></td></tr><tr id="type-outcome.Raised" class="anchored"><td class="def constructor"><a href="#type-outcome.Raised" class="anchor"></a><code><span>| </span></code><code><span>`Raised <span class="keyword">of</span> exn</span></code></td></tr></table><code><span> ]</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-sexp_of_outcome" class="anchored"><a href="#val-sexp_of_outcome" class="anchor"></a><code><span><span class="keyword">val</span> sexp_of_outcome : 
  <span><span>( <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Sexplib0</span>.Sexp.t )</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-outcome">outcome</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Sexplib0</span>.Sexp.t</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-enqueue'" class="anchored"><a href="#val-enqueue'" class="anchor"></a><code><span><span class="keyword">val</span> enqueue' : 
  <span><span><span>( <span class="type-var">'a</span>, <span class="type-var">_</span> )</span> <a href="T2/index.html#type-t">T2.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>( <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <a href="../Deferred/index.html#type-t">Deferred.t</a></span> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'b</span> <a href="#type-outcome">outcome</a></span> <a href="../Deferred/index.html#type-t">Deferred.t</a></span></span></code></div><div class="spec-doc"><p><code>enqueue t job</code> schedules <code>job</code> to be run as soon as possible. Jobs are guaranteed to be started in the order they are <code>enqueue</code>d and to not be started during the call to <code>enqueue</code>. If <code>t</code> is dead, then <code>job</code> will be immediately aborted (for <code>enqueue</code>, this will send an exception to the monitor in effect).</p></div></div><div class="odoc-spec"><div class="spec value" id="val-enqueue" class="anchored"><a href="#val-enqueue" class="anchor"></a><code><span><span class="keyword">val</span> enqueue : <span><span><span>( <span class="type-var">'a</span>, <span class="type-var">_</span> )</span> <a href="T2/index.html#type-t">T2.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>( <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <a href="../Deferred/index.html#type-t">Deferred.t</a></span> )</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <a href="../Deferred/index.html#type-t">Deferred.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-enqueue_exclusive" class="anchored"><a href="#val-enqueue_exclusive" class="anchor"></a><code><span><span class="keyword">val</span> enqueue_exclusive : 
  <span><span><span>( <span class="type-var">'a</span>, <span class="type-var">_</span> )</span> <a href="T2/index.html#type-t">T2.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>( <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <a href="../Deferred/index.html#type-t">Deferred.t</a></span> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'b</span> <a href="../Deferred/index.html#type-t">Deferred.t</a></span></span></code></div><div class="spec-doc"><p><code>enqueue_exclusive</code> schedules a job that occupies all slots of the throttle, so it won't run concurrently with any other job. The job counts as being enqueued normally, so it runs after the jobs enqueued previously and before the jobs enqueued later. <code>enqueue_exclusive</code> takes O(max_concurrent_jobs) time, so you should not use it when <code>max_concurrent_jobs = Int.max_value</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-monad_sequence_how" class="anchored"><a href="#val-monad_sequence_how" class="anchor"></a><code><span><span class="keyword">val</span> monad_sequence_how : 
  <span>how:<a href="../Monad_sequence/index.html#type-how">Monad_sequence.how</a> <span class="arrow">&#45;&gt;</span></span>
  <span>f:<span>( <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <a href="../Deferred/index.html#type-t">Deferred.t</a></span> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>( <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <a href="../Deferred/index.html#type-t">Deferred.t</a></span> )</span> <a href="../../../base/Base/Staged/index.html#type-t">Core.Staged.t</a></span></span></code></div><div class="spec-doc"><p><code>monad_sequence_how ~how ~f</code> returns a function that behaves like <code>f</code>, except that it uses a throttle to limit the number of concurrent invocations that can be running simultaneously. The throttle has <code>continue_on_error = false</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-monad_sequence_how2" class="anchored"><a href="#val-monad_sequence_how2" class="anchor"></a><code><span><span class="keyword">val</span> monad_sequence_how2 : 
  <span>how:<a href="../Monad_sequence/index.html#type-how">Monad_sequence.how</a> <span class="arrow">&#45;&gt;</span></span>
  <span>f:<span>( <span><span class="type-var">'a1</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a2</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <a href="../Deferred/index.html#type-t">Deferred.t</a></span> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>( <span><span class="type-var">'a1</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a2</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <a href="../Deferred/index.html#type-t">Deferred.t</a></span> )</span> <a href="../../../base/Base/Staged/index.html#type-t">Core.Staged.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-prior_jobs_done" class="anchored"><a href="#val-prior_jobs_done" class="anchor"></a><code><span><span class="keyword">val</span> prior_jobs_done : <span><span><span>( <span class="type-var">_</span>, <span class="type-var">_</span> )</span> <a href="T2/index.html#type-t">T2.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../Deferred/index.html#type-t">Deferred.t</a></span></span></code></div><div class="spec-doc"><p><code>prior_jobs_done t</code> becomes determined when all of the jobs that were previously enqueued in <code>t</code> have completed.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-max_concurrent_jobs" class="anchored"><a href="#val-max_concurrent_jobs" class="anchor"></a><code><span><span class="keyword">val</span> max_concurrent_jobs : <span><span><span>( <span class="type-var">_</span>, <span class="type-var">_</span> )</span> <a href="T2/index.html#type-t">T2.t</a></span> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>max_concurrent_jobs t</code> returns the maximum number of jobs that <code>t</code> will run concurrently.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-num_jobs_running" class="anchored"><a href="#val-num_jobs_running" class="anchor"></a><code><span><span class="keyword">val</span> num_jobs_running : <span><span><span>( <span class="type-var">_</span>, <span class="type-var">_</span> )</span> <a href="T2/index.html#type-t">T2.t</a></span> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>num_jobs_running t</code> returns the number of jobs that <code>t</code> is currently running. It is guaranteed that if <code>num_jobs_running t &lt; max_concurrent_jobs t</code> then <code>num_jobs_waiting_to_start t = 0</code>. That is, the throttle always uses its maximum concurrency if possible.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-num_jobs_waiting_to_start" class="anchored"><a href="#val-num_jobs_waiting_to_start" class="anchor"></a><code><span><span class="keyword">val</span> num_jobs_waiting_to_start : <span><span><span>( <span class="type-var">_</span>, <span class="type-var">_</span> )</span> <a href="T2/index.html#type-t">T2.t</a></span> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>num_jobs_waiting_to_start t</code> returns the number of jobs that have been <code>enqueue</code>d but have not yet started.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-capacity_available" class="anchored"><a href="#val-capacity_available" class="anchor"></a><code><span><span class="keyword">val</span> capacity_available : <span><span><span>( <span class="type-var">_</span>, <span class="type-var">_</span> )</span> <a href="T2/index.html#type-t">T2.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../Deferred/index.html#type-t">Deferred.t</a></span></span></code></div><div class="spec-doc"><p><code>capacity_available t</code> becomes determined the next time that <code>t</code> has fewer than <code>max_concurrent_jobs t</code> running, and hence an <code>enqueue</code>d job would start immediately.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-kill" class="anchored"><a href="#val-kill" class="anchor"></a><code><span><span class="keyword">val</span> kill : <span><span><span>( <span class="type-var">_</span>, <span class="type-var">_</span> )</span> <a href="T2/index.html#type-t">T2.t</a></span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>kill t</code> kills <code>t</code>, which aborts all enqueued jobs that haven't started and all jobs enqueued in the future. <code>kill</code> also initiates the <code>at_kill</code> clean functions.</p><p>If <code>t</code> has already been killed, then calling <code>kill t</code> has no effect.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-is_dead" class="anchored"><a href="#val-is_dead" class="anchor"></a><code><span><span class="keyword">val</span> is_dead : <span><span><span>( <span class="type-var">_</span>, <span class="type-var">_</span> )</span> <a href="T2/index.html#type-t">T2.t</a></span> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>is_dead t</code> returns <code>true</code> if <code>t</code> was killed, either by <code>kill</code> or by an unhandled exception in a job.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-at_kill" class="anchored"><a href="#val-at_kill" class="anchor"></a><code><span><span class="keyword">val</span> at_kill : <span><span><span>( <span class="type-var">'a</span>, <span class="type-var">_</span> )</span> <a href="T2/index.html#type-t">T2.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>( <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../Deferred/index.html#type-t">Deferred.t</a></span> )</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>at_kill t clean</code> runs <code>clean</code> on each resource when <code>t</code> is killed, either by <code>kill</code> or by an unhandled exception. <code>clean</code> is called on each resource as it becomes available, i.e., immediately if the resource isn't currently in use, otherwise when the job currently using the resource finishes. If a call to <code>clean</code> fails, the exception is raised to the monitor in effect when <code>at_kill</code> was called.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-cleaned" class="anchored"><a href="#val-cleaned" class="anchor"></a><code><span><span class="keyword">val</span> cleaned : <span><span><span>( <span class="type-var">_</span>, <span class="type-var">_</span> )</span> <a href="T2/index.html#type-t">T2.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../Deferred/index.html#type-t">Deferred.t</a></span></span></code></div><div class="spec-doc"><p><code>cleaned t</code> becomes determined after <code>t</code> is killed, all its running jobs have completed, and all <code>at_kill</code> clean functions have completed.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Sequencer" class="anchored"><a href="#module-Sequencer" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Sequencer/index.html">Sequencer</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>A sequencer is a throttle that is specialized to only allow one job at a time and to, by default, not continue on error.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Deferred" class="anchored"><a href="#module-Deferred" class="anchor"></a><code><span><span class="keyword">module</span> Deferred</span><span> = <a href="../../Async_kernel__/Deferred1/index.html">Async_kernel__Deferred1</a></span></code></div></div></div></body></html>