<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Limiter (core_kernel.Limiter)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../index.html">core_kernel</a> &#x00BB; Limiter</nav><header class="odoc-preamble"><h1>Module <code><span>Limiter</span></code></h1><p>Implements a token-bucket-based throttling rate limiter. This module is useful for limiting network clients to a sensible query rate, or in any case where you have jobs that consume a scarce but replenishable resource.</p><p>In a standard token bucket there is an infinite incoming supply of tokens that fill a single bucket.</p><p>This version implements a closed system where tokens move through three possible states:</p><ul><li>in hopper</li><li>in bucket</li><li>in flight</li></ul><p>Tokens &quot;drop&quot; from the hopper into the bucket at a set rate, and can be taken from the bucket by clients and put into flight. Once the client is finished with whatever tokens are required for its task, it is responsible for moving them from &quot;in flight&quot; back into the hopper.</p><p>Most use cases are covered by the <code>Token_bucket</code>, <code>Throttle</code>, and <code>Throttled_rate_limiter</code> modules, but the <code>Expert</code> module provides full access to the module internals.</p><p>This interface is the simple, non-concurrent interface, and requires machinery on top to implement a specific strategy. See <code>Limiter_async</code> for an async-friendly implementation on top of this module.</p><p>Most functions in this interface take an explicit time as an argument. <code>now</code> is expected to be monotonically increasing. <code>now</code>'s that are set in the past are effectively moved up to the current time of the bucket.</p></header><nav class="odoc-toc"><ul><li><a href="#common-read-only-operations">Common read-only operations</a></li></ul></nav><div class="odoc-content"><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-sexp_of_t" class="anchored"><a href="#val-sexp_of_t" class="anchor"></a><code><span><span class="keyword">val</span> sexp_of_t : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Sexplib0</span>.Sexp.t</span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-limiter" class="anchored"><a href="#type-limiter" class="anchor"></a><code><span><span class="keyword">type</span> limiter</span><span> = <a href="#type-t">t</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-sexp_of_limiter" class="anchored"><a href="#val-sexp_of_limiter" class="anchor"></a><code><span><span class="keyword">val</span> sexp_of_limiter : <span><a href="#type-limiter">limiter</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Sexplib0</span>.Sexp.t</span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Infinite_or_finite" class="anchored"><a href="#module-Infinite_or_finite" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Infinite_or_finite/index.html">Infinite_or_finite</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Try_take_result" class="anchored"><a href="#module-Try_take_result" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Try_take_result/index.html">Try_take_result</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Try_return_to_bucket_result" class="anchored"><a href="#module-Try_return_to_bucket_result" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Try_return_to_bucket_result/index.html">Try_return_to_bucket_result</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Tokens_may_be_available_result" class="anchored"><a href="#module-Tokens_may_be_available_result" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Tokens_may_be_available_result/index.html">Tokens_may_be_available_result</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Try_reconfigure_result" class="anchored"><a href="#module-Try_reconfigure_result" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Try_reconfigure_result/index.html">Try_reconfigure_result</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Token_bucket" class="anchored"><a href="#module-Token_bucket" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Token_bucket/index.html">Token_bucket</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Implements a basic token-bucket-based rate limiter. Users of the throttle must successfully call <code>try_take</code> before doing work.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Throttle" class="anchored"><a href="#module-Throttle" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Throttle/index.html">Throttle</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Implements a basic throttle. Users of the throttle must successfully call <code>start_job</code> before beginning work and must call <code>finish_job</code> once, and only once, when a job is completed.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Throttled_rate_limiter" class="anchored"><a href="#module-Throttled_rate_limiter" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Throttled_rate_limiter/index.html">Throttled_rate_limiter</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>A <code>Throttled_rate_limiter</code> combines a <code>Token_bucket</code> and a <code>Throttle</code>. Unlike a <code>Token_bucket</code>, jobs cannot consume variable numbers of tokens, but the number of outstanding jobs is also limited to <code>max_concurrent_jobs</code>. Like a <code>Throttle</code>, <code>finish_job</code> must be called once, and only once, when a job is completed.</p></div></div><h3 id="common-read-only-operations"><a href="#common-read-only-operations" class="anchor"></a>Common read-only operations</h3><div class="odoc-spec"><div class="spec value" id="val-bucket_limit" class="anchored"><a href="#val-bucket_limit" class="anchor"></a><code><span><span class="keyword">val</span> bucket_limit : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-in_bucket" class="anchored"><a href="#val-in_bucket" class="anchor"></a><code><span><span class="keyword">val</span> in_bucket : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>now:<a href="../../core/Core/Time_ns/index.html#type-t">Core.Time_ns.t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Tokens available to immediately take.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-in_hopper" class="anchored"><a href="#val-in_hopper" class="anchor"></a><code><span><span class="keyword">val</span> in_hopper : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>now:<a href="../../core/Core/Time_ns/index.html#type-t">Core.Time_ns.t</a> <span class="arrow">&#45;&gt;</span></span> <span>int <a href="Infinite_or_finite/index.html#type-t">Infinite_or_finite.t</a></span></span></code></div><div class="spec-doc"><p>Tokens waiting to drop at the <code>hopper_to_bucket_rate_per_sec</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-in_flight" class="anchored"><a href="#val-in_flight" class="anchor"></a><code><span><span class="keyword">val</span> in_flight : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>now:<a href="../../core/Core/Time_ns/index.html#type-t">Core.Time_ns.t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Tokens that have been taken, but not yet returned.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-in_limiter" class="anchored"><a href="#val-in_limiter" class="anchor"></a><code><span><span class="keyword">val</span> in_limiter : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>now:<a href="../../core/Core/Time_ns/index.html#type-t">Core.Time_ns.t</a> <span class="arrow">&#45;&gt;</span></span> <span>int <a href="Infinite_or_finite/index.html#type-t">Infinite_or_finite.t</a></span></span></code></div><div class="spec-doc"><p>Total number of tokens in the limiter <code>in_hopper + in_bucket</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-in_system" class="anchored"><a href="#val-in_system" class="anchor"></a><code><span><span class="keyword">val</span> in_system : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>now:<a href="../../core/Core/Time_ns/index.html#type-t">Core.Time_ns.t</a> <span class="arrow">&#45;&gt;</span></span> <span>int <a href="Infinite_or_finite/index.html#type-t">Infinite_or_finite.t</a></span></span></code></div><div class="spec-doc"><p>Total number of tokens in the entire system <code>in_hopper + in_bucket + in_flight</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-hopper_to_bucket_rate_per_sec" class="anchored"><a href="#val-hopper_to_bucket_rate_per_sec" class="anchor"></a><code><span><span class="keyword">val</span> hopper_to_bucket_rate_per_sec : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>float <a href="Infinite_or_finite/index.html#type-t">Infinite_or_finite.t</a></span></span></code></div><div class="spec-doc"><p>Note that this isn't guaranteed to be equal to the <code>rate_per_sec</code> that was passed in to the constructor, due to floating point error.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Expert" class="anchored"><a href="#module-Expert" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Expert/index.html">Expert</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Expert operations.</p></div></div><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <a href="../../base/Base/Invariant/module-type-S/index.html">Core.Invariant.S</a> <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="../../base/Base/Invariant/module-type-S/index.html#type-t">t</a> := <a href="#type-t">t</a></span></span></code></summary><div class="odoc-spec"><div class="spec value" id="val-invariant" class="anchored"><a href="#val-invariant" class="anchor"></a><code><span><span class="keyword">val</span> invariant : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div></details></div></div></body></html>