<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Bus (core_kernel.Bus)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../index.html">core_kernel</a> &#x00BB; Bus</nav><header class="odoc-preamble"><h1>Module <code><span>Bus</span></code></h1><p>A <code>Bus</code> is a publisher/subscriber system within the memory space of the program. A bus has a mutable set of subscribers, which can be modified using <code>subscribe_exn</code> and <code>unsubscribe</code>.</p><p><code>create</code> returns a <code>Bus.Read_write.t</code>, which you can use to <code>write</code> values to the bus. <code>write</code> calls the callbacks of all current subscribers before returning.</p><p>In a <code>('callback, 'phantom) Bus.t</code>, <code>'phantom</code> is a read-write phantom type that controls whether one can read values from or write values to the bus. The phantom type states the capabilities one could ever have access to, not the capabilities that are immediately available. In particular, if one wants to subscribe to a <code>Bus.Read_write.t</code>, one must call <code>read_only</code> on it in order to get a <code>Bus.Read_only.t</code> that can be passed to <code>subscribe_exn</code>. This is deliberate, and is meant to avoid unintentional reads from code that should only be writing.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec module" id="module-Callback_arity" class="anchored"><a href="#module-Callback_arity" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Callback_arity/index.html">Callback_arity</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p><code>Callback_arity</code> states the type of callbacks stored in a bus. Using <code>Callback_arity</code> is an implementation technique that allows callbacks to be defined as ordinary n-ary curried functions (e.g., <code>a1 -&gt; a2 -&gt; a3 -&gt; r</code>), instead of forcing n-ary-variadic callbacks to use tuples (e.g., <code>a1 * a2 * a3 -&gt; r</code>). This also avoids extra allocation.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span>('callback, 'phantom) t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-sexp_of_t" class="anchored"><a href="#val-sexp_of_t" class="anchor"></a><code><span><span class="keyword">val</span> sexp_of_t : 
  <span><span>( <span><span class="type-var">'callback</span> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Sexplib0</span>.Sexp.t )</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>( <span><span class="type-var">'phantom</span> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Sexplib0</span>.Sexp.t )</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>( <span class="type-var">'callback</span>, <span class="type-var">'phantom</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Sexplib0</span>.Sexp.t</span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-bus" class="anchored"><a href="#type-bus" class="anchor"></a><code><span><span class="keyword">type</span> <span>('callback, 'phantom) bus</span></span><span> = <span><span>( <span class="type-var">'callback</span>, <span class="type-var">'phantom</span> )</span> <a href="#type-t">t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Read_write" class="anchored"><a href="#module-Read_write" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Read_write/index.html">Read_write</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Read_only" class="anchored"><a href="#module-Read_only" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Read_only/index.html">Read_only</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-On_subscription_after_first_write" class="anchored"><a href="#module-On_subscription_after_first_write" class="anchor"></a><code><span><span class="keyword">module</span> <a href="On_subscription_after_first_write/index.html">On_subscription_after_first_write</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-read_only" class="anchored"><a href="#val-read_only" class="anchor"></a><code><span><span class="keyword">val</span> read_only : <span><span><span>( <span class="type-var">'callback</span>, <span class="type-var">_</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'callback</span> <a href="Read_only/index.html#type-t">Read_only.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-create" class="anchored"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : 
  <span>?name:<a href="../../core/Core/Info/index.html#type-t">Core.Info.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../core/Core/Source_code_position/index.html#type-t">Core.Source_code_position.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'callback</span> <a href="Callback_arity/index.html#type-t">Callback_arity.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span>on_subscription_after_first_write:<a href="On_subscription_after_first_write/index.html#type-t">On_subscription_after_first_write.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>on_callback_raise:<span>( <span><a href="../../core/Core/Error/index.html#type-t">Core.Error.t</a> <span class="arrow">&#45;&gt;</span></span> unit )</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'callback</span> <a href="Read_write/index.html#type-t">Read_write.t</a></span></span></code></div><div class="spec-doc"><p>In <code>create [%here] ArityN ~on_subscription_after_first_write ~on_callback_raise</code>, <code>[%here]</code> is stored in the resulting bus, and contained in <code>%sexp_of: t</code>, which can help with debugging.</p><p>If <code>on_subscription_after_first_write</code> is <code>Raise</code>, then <code>subscribe_exn</code> will raise if it is called after <code>write</code> has been called the first time. If <code>on_subscription_after_first_write</code> is <code>Allow_and_send_last_value</code>, then the bus will remember the last value written and will send it to new subscribers.</p><p>If a callback raises, <code>on_callback_raise</code> is called with an error containing the exception.</p><p>If <code>on_callback_raise</code> raises, then the exception is raised to <code>write</code> and the bus is closed.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-callback_arity" class="anchored"><a href="#val-callback_arity" class="anchor"></a><code><span><span class="keyword">val</span> callback_arity : <span><span><span>( <span class="type-var">'callback</span>, <span class="type-var">_</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'callback</span> <a href="Callback_arity/index.html#type-t">Callback_arity.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-num_subscribers" class="anchored"><a href="#val-num_subscribers" class="anchor"></a><code><span><span class="keyword">val</span> num_subscribers : <span><span><span>( <span class="type-var">_</span>, <span class="type-var">_</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> int</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-is_closed" class="anchored"><a href="#val-is_closed" class="anchor"></a><code><span><span class="keyword">val</span> is_closed : <span><span><span>( <span class="type-var">_</span>, <span class="type-var">_</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-close" class="anchored"><a href="#val-close" class="anchor"></a><code><span><span class="keyword">val</span> close : <span><span><span class="type-var">'callback</span> <a href="Read_write/index.html#type-t">Read_write.t</a></span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>close</code> disallows future <code>write</code>s -- once <code>close t</code> is called, all further calls to <code>write t</code> will raise. <code>close</code> is idempotent. If <code>close</code> is called from within a callback, the current message will still be sent to all subscribed callbacks that have not yet seen it before the close takes effect.</p></div></div><p><code>write</code> ... <code>write5</code> call all callbacks currently subscribed to the bus, with no guarantee on the order in which they will be called. <code>write</code> is non-allocating, though the callbacks themselves may allocate. Calling <code>writeN t</code> raises if called from within a callback on <code>t</code> or when <code>is_closed t</code>.</p><div class="odoc-spec"><div class="spec value" id="val-write" class="anchored"><a href="#val-write" class="anchor"></a><code><span><span class="keyword">val</span> write : <span><span><span>( <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> unit )</span> <a href="Read_write/index.html#type-t">Read_write.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-write2" class="anchored"><a href="#val-write2" class="anchor"></a><code><span><span class="keyword">val</span> write2 : <span><span><span>( <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <span class="arrow">&#45;&gt;</span></span> unit )</span> <a href="Read_write/index.html#type-t">Read_write.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-write3" class="anchored"><a href="#val-write3" class="anchor"></a><code><span><span class="keyword">val</span> write3 : <span><span><span>( <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'c</span> <span class="arrow">&#45;&gt;</span></span> unit )</span> <a href="Read_write/index.html#type-t">Read_write.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'c</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-write4" class="anchored"><a href="#val-write4" class="anchor"></a><code><span><span class="keyword">val</span> write4 : 
  <span><span><span>( <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'c</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'d</span> <span class="arrow">&#45;&gt;</span></span> unit )</span> <a href="Read_write/index.html#type-t">Read_write.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'b</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'c</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'d</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-write5" class="anchored"><a href="#val-write5" class="anchor"></a><code><span><span class="keyword">val</span> write5 : 
  <span><span><span>( <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'c</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'d</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'e</span> <span class="arrow">&#45;&gt;</span></span> unit )</span> <a href="Read_write/index.html#type-t">Read_write.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'b</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'c</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'d</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'e</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Subscriber" class="anchored"><a href="#module-Subscriber" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Subscriber/index.html">Subscriber</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-subscribe_exn" class="anchored"><a href="#val-subscribe_exn" class="anchor"></a><code><span><span class="keyword">val</span> subscribe_exn : 
  <span>?extract_exn:bool <span class="arrow">&#45;&gt;</span></span>
  <span>?on_callback_raise:<span>( <span><a href="../../core/Core/Error/index.html#type-t">Core.Error.t</a> <span class="arrow">&#45;&gt;</span></span> unit )</span> <span class="arrow">&#45;&gt;</span></span>
  <span>?on_close:<span>( <span>unit <span class="arrow">&#45;&gt;</span></span> unit )</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>( <span class="type-var">'callback</span>, <span>[&gt; <a href="../../core/Core/index.html#type-read">Core.read</a> ]</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../core/Core/Source_code_position/index.html#type-t">Core.Source_code_position.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>f:<span class="type-var">'callback</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'callback</span> <a href="Subscriber/index.html#type-t">Subscriber.t</a></span></span></code></div><div class="spec-doc"><p><code>subscribe_exn t [%here] ~f</code> adds the callback <code>f</code> to the set of <code>t</code>'s subscribers, and returns a <code>Subscriber.t</code> that can later be used to <code>unsubscribe</code>. <code>[%here]</code> is stored in the <code>Subscriber.t</code>, and contained in <code>%sexp_of: Subscriber.t</code>, which can help with debugging. If <code>subscribe_exn t</code> is called by a callback in <code>t</code>, i.e., during <code>write t</code>, the subscription takes effect for the next <code>write</code>, but does not affect the current <code>write</code>. <code>subscribe_exn</code> takes amortized constant time.</p><p>If <code>on_callback_raise</code> is supplied, then it will be called by <code>write</code> whenever <code>f</code> raises; only if that subsequently raises will <code>t</code>'s <code>on_callback_raise</code> be called. If <code>on_callback_raise</code> is not supplied, then <code>t</code>'s <code>on_callback_raise</code> will be called whenever <code>f</code> raises.</p><p>If <code>on_callback_raise</code> is supplied and <code>extract_exn</code> is set to true, then the error passed to the <code>on_callback_raise</code> method will contain only the exception raised by <code>f</code> without any additional information about the bus subscription or backtrace.</p><p><code>on_close</code> is called if you are still subscribed when <code>Bus.close</code> is called.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-iter_exn" class="anchored"><a href="#val-iter_exn" class="anchor"></a><code><span><span class="keyword">val</span> iter_exn : 
  <span>?extract_exn:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>( <span class="type-var">'callback</span>, <span>[&gt; <a href="../../core/Core/index.html#type-read">Core.read</a> ]</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../core/Core/Source_code_position/index.html#type-t">Core.Source_code_position.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>f:<span class="type-var">'callback</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>iter_exn t [%here] ~f</code> is <code>ignore (subscribe_exn t [%here] ~callback:f)</code>. This captures the common usage in which one never wants to unsubscribe from a bus.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Fold_arity" class="anchored"><a href="#module-Fold_arity" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Fold_arity/index.html">Fold_arity</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-fold_exn" class="anchored"><a href="#val-fold_exn" class="anchor"></a><code><span><span class="keyword">val</span> fold_exn : 
  <span>?extract_exn:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>( <span class="type-var">'callback</span>, <span>[&gt; <a href="../../core/Core/index.html#type-read">Core.read</a> ]</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../core/Core/Source_code_position/index.html#type-t">Core.Source_code_position.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>( <span class="type-var">'callback</span>, <span class="type-var">'f</span>, <span class="type-var">'s</span> )</span> <a href="Fold_arity/index.html#type-t">Fold_arity.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span>init:<span class="type-var">'s</span> <span class="arrow">&#45;&gt;</span></span>
  <span>f:<span class="type-var">'f</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>fold_exn t [%here] arity ~init ~f</code> folds over the bus events, threading a state value to every call. It is otherwise similar to <code>iter_exn</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-unsubscribe" class="anchored"><a href="#val-unsubscribe" class="anchor"></a><code><span><span class="keyword">val</span> unsubscribe : 
  <span><span><span>( <span class="type-var">'callback</span>, <span>[&gt; <a href="../../core/Core/index.html#type-read">Core.read</a> ]</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'callback</span> <a href="Subscriber/index.html#type-t">Subscriber.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>unsubscribe t subscriber</code> removes the callback corresponding to <code>subscriber</code> from <code>t</code>. <code>unsubscribe</code> never raises and is idempotent. As with <code>subscribe_exn</code>, <code>unsubscribe t</code> during <code>write t</code> takes effect after the current <code>write</code> finishes. Also like <code>subscribe_exn</code>, <code>unsubscribe</code> takes amortized constant time.</p></div></div></div></body></html>